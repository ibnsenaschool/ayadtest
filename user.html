<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Market Sell - ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨ÙˆØª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #ff6b6b, #ffc107);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .card h2 {
            color: #ffc107;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .steps {
            list-style: none;
            counter-reset: step;
        }
        
        .steps li {
            counter-increment: step;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            position: relative;
            padding-right: 60px;
        }
        
        .steps li::before {
            content: counter(step);
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 35px;
            height: 35px;
            background: linear-gradient(45deg, #ff6b6b, #ffc107);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #1a1a2e;
        }
        
        .bookmarklet-btn {
            display: block;
            width: 100%;
            padding: 20px;
            background: linear-gradient(45deg, #ff6b6b, #ffc107);
            color: #1a1a2e;
            text-align: center;
            text-decoration: none;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 10px;
            margin: 20px 0;
            cursor: grab;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .bookmarklet-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(255,107,107,0.3);
        }
        
        .bookmarklet-btn:active {
            cursor: grabbing;
        }
        
        .warning {
            background: rgba(255,193,7,0.2);
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .warning-title {
            color: #ffc107;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .success {
            background: rgba(76,175,80,0.2);
            border: 1px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .feature {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .feature-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
        }
        
        code {
            background: rgba(0,0,0,0.5);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .new-feature {
            background: rgba(76,175,80,0.3);
            border: 1px solid #4CAF50;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’° Auto Market Sell</h1>
        <p class="subtitle">Ø¨ÙˆØª Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ <span class="new-feature">ğŸ”¥ ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©</span></p>
        
        <div class="card">
            <h2>âœ¨ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª</h2>
            <div class="features">
                <div class="feature">
                    <div class="feature-icon">ğŸ“Š</div>
                    <div>ÙØ­Øµ Ø§Ù„Ø¹ØªØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div>
                </div>
                <div class="feature">
                    <div class="feature-icon">ğŸ””</div>
                    <div>ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ</div>
                </div>
                <div class="feature">
                    <div class="feature-icon">ğŸ”„</div>
                    <div><span class="new-feature">Ø¬Ø¯ÙŠØ¯</span>ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©</div>
                </div>
                <div class="feature">
                    <div class="feature-icon">âš¡</div>
                    <div>Ø¨ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>ğŸ“¥ Ø§Ù„ØªØ«Ø¨ÙŠØª</h2>
            
            <div class="warning">
                <div class="warning-title">âš ï¸ Ù…Ù‡Ù…</div>
                Ø§Ø³Ø­Ø¨ Ø§Ù„Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ø¥Ù„Ù‰ Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙØ¶Ù„Ø© (Bookmarks Bar)
            </div>
            
            <!-- Bookmarklet Button -->
            <a class="bookmarklet-btn" id="bookmarklet-link" href="#">
                ğŸ’° Ø§Ø³Ø­Ø¨Ù†ÙŠ Ù„Ù„Ù…ÙØ¶Ù„Ø© - Auto Sell
            </a>
            
            <ol class="steps">
                <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± <strong>Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙØ¶Ù„Ø©</strong> ÙÙŠ Ù…ØªØµÙØ­Ùƒ (Ctrl+Shift+B)</li>
                <li><strong>Ø§Ø³Ø­Ø¨ Ø§Ù„Ø²Ø± Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</strong> Ø£Ø¹Ù„Ø§Ù‡ ÙˆØ£ÙÙ„ØªÙ‡ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙØ¶Ù„Ø©</li>
                <li>Ø§ÙØªØ­ ØµÙØ­Ø© <strong>Ø§Ù„Ø³ÙˆÙ‚</strong> ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© (mode=exchange)</li>
                <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± ÙÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª</li>
            </ol>
            
            <div class="success">
                <strong>âœ… Ø¬Ø§Ù‡Ø²!</strong> Ø§Ù„Ø¨ÙˆØª Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
                <br><strong>ğŸ”¥ Ø¬Ø¯ÙŠØ¯:</strong> Ø§Ù„Ø¨ÙˆØª ÙŠØ³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù†ØªÙ‚Ù„Øª Ù„ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø±!
            </div>
        </div>
        
        <div class="card">
            <h2>ğŸ“– Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</h2>
            <ul class="steps">
                <li>Ø­Ø¯Ø¯ <strong>Ø§Ù„Ø¹ØªØ¨Ø©</strong> - Ø§Ù„Ø¨ÙˆØª ÙŠØ¨ÙŠØ¹ Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ Ø£Ù‚Ù„ Ø£Ùˆ ØªØ³Ø§ÙˆÙŠ Ø§Ù„Ø¹ØªØ¨Ø©</li>
                <li>ÙØ¹Ù‘Ù„ <code>ğŸ”Š ØµÙˆØª</code> Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ù„Ø¨ÙŠØ¹</li>
                <li>ÙØ¹Ù‘Ù„ <code>ğŸ”„ Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</code> Ù„Ù„Ø¨ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</li>
                <li>Ø§Ù„Ø¨ÙˆØª ÙŠÙØ­Øµ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØºÙŠÙŠØ±)</li>
            </ul>
        </div>
        
        <div class="card">
            <h2>âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
            <div class="warning">
                <ul style="list-style: disc; padding-right: 20px; line-height: 2;">
                    <li><strong>ğŸ”¥ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©</strong> - ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø£Ø®Ø±Ù‰</li>
                    <li>Ù„Ø§ ØªØºÙ„Ù‚ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø³ÙˆÙ‚ (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ±ÙƒÙ‡ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©)</li>
                    <li>ÙŠØ­ØªÙØ¸ Ø§Ù„Ø¨ÙˆØª Ø¨Ù€ 1000 Ù…Ù† ÙƒÙ„ Ù…ÙˆØ±Ø¯ ÙƒØ§Ø­ØªÙŠØ§Ø·ÙŠ</li>
                    <li>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© Ù…Ø­Ø¯ÙˆØ¯Ø© Ø¨Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¬Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†</li>
                </ul>
            </div>
        </div>
        
        <div class="footer">
            <p>ğŸ“± Ù„Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„ØªØ¬Ø¯ÙŠØ¯: @YourTelegram</p>
            <p style="margin-top: 10px; font-size: 12px;">Auto Market Sell v5.0 - Background Edition</p>
        </div>
    </div>
    
    <script>
    const bookmarkletCode = `
(function(){
    var EXPIRY_DATE = "2026-12-01";
    var USER_NAME = decodeURIComponent("%D8%A7%D9%84%D9%85%D8%B4%D8%AA%D8%B1%D9%83");
    var CLICK_DELAY = 1000;
    var BETWEEN_SELL_DELAY = 10000;
    var MERCHANT_CAPACITY = 1000;
    var BUFFER = 500;
    var RESOURCE_BUFFER = 1000;
    var DEFAULT_INTERVAL = 30000;
    var DEFAULT_THRESHOLD = 101;
    
    var TEXTS = {
        title: decodeURIComponent("%D8%A8%D9%8A%D8%B9%20%D8%AA%D9%84%D9%82%D8%A7%D8%A6%D9%8A"),
        wood: decodeURIComponent("%D8%AE%D8%B4%D8%A8"),
        stone: decodeURIComponent("%D8%B7%D9%85%D9%8A"),
        iron: decodeURIComponent("%D8%AD%D8%AF%D9%8A%D8%AF"),
        autoSell: decodeURIComponent("%D8%A8%D9%8A%D8%B9%20%D8%AA%D9%84%D9%82%D8%A7%D8%A6%D9%8A"),
        sound: decodeURIComponent("%D8%B5%D9%88%D8%AA"),
        stop: decodeURIComponent("%D8%A5%D9%8A%D9%82%D8%A7%D9%81"),
        start: decodeURIComponent("%D8%AA%D8%B4%D8%BA%D9%8A%D9%84"),
        runNow: decodeURIComponent("%D8%AA%D8%B4%D8%BA%D9%8A%D9%84%20%D8%A7%D9%84%D8%A2%D9%86"),
        close: decodeURIComponent("%D8%A5%D8%BA%D9%84%D8%A7%D9%82"),
        period: decodeURIComponent("%D8%A7%D9%84%D9%81%D8%AA%D8%B1%D8%A9"),
        threshold: decodeURIComponent("%D8%A7%D9%84%D8%B9%D8%AA%D8%A8%D8%A9"),
        log: decodeURIComponent("%D8%A7%D9%84%D8%B3%D8%AC%D9%84"),
        day: decodeURIComponent("%D9%8A%D9%88%D9%85"),
        expired: decodeURIComponent("%D8%B9%D8%B2%D9%8A%D8%B2%D9%8A%20%D8%A7%D9%84%D9%85%D8%B4%D8%AA%D8%B1%D9%83%20%D9%8A%D8%B1%D8%AC%D9%89%20%D8%AA%D8%AC%D8%AF%D9%8A%D8%AF%20%D8%A7%D9%84%D8%A7%D8%B4%D8%AA%D8%B1%D8%A7%D9%83"),
        myResources: decodeURIComponent("%D9%85%D9%88%D8%A7%D8%B1%D8%AF%D9%8A"),
        reserve: decodeURIComponent("%D8%A7%D8%AD%D8%AA%D9%8A%D8%A7%D8%B7%D9%8A"),
        running: decodeURIComponent("%D8%A7%D9%84%D8%A8%D9%88%D8%AA%20%D9%8A%D8%B9%D9%85%D9%84"),
        noMerchants: decodeURIComponent("%D9%84%D8%A7%20%D9%8A%D9%88%D8%AC%D8%AF%20%D8%AA%D8%AC%D8%A7%D8%B1"),
        done: decodeURIComponent("%D8%AA%D9%85"),
        checking: decodeURIComponent("%D9%81%D8%AD%D8%B5"),
        sold: decodeURIComponent("%D8%AA%D9%85%20%D8%A7%D9%84%D8%A8%D9%8A%D8%B9"),
        thresholdMet: decodeURIComponent("%D8%A7%D9%84%D8%B9%D8%AA%D8%A8%D8%A9%20%D8%AA%D8%AD%D9%82%D9%82%D8%AA"),
        background: decodeURIComponent("%D9%8A%D8%B9%D9%85%D9%84%20%D9%81%D9%8A%20%D8%A7%D9%84%D8%AE%D9%84%D9%81%D9%8A%D8%A9")
    };
    
    function checkSub(cb) {
        fetch("https://worldtimeapi.org/api/ip")
        .then(function(r){ return r.json(); })
        .then(function(data){
            var cur = new Date(data.datetime);
            var exp = new Date(EXPIRY_DATE);
            if(cur > exp) cb({valid:false});
            else cb({valid:true, days: Math.ceil((exp-cur)/(1000*60*60*24))});
        })
        .catch(function(){
            var cur = new Date();
            var exp = new Date(EXPIRY_DATE);
            if(cur > exp) cb({valid:false});
            else cb({valid:true, days: Math.ceil((exp-cur)/(1000*60*60*24))});
        });
    }
    
    function showExpired() {
        var d = document.createElement("div");
        d.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999999;background:linear-gradient(135deg,#ff4444,#cc0000);color:white;padding:40px;border-radius:15px;text-align:center;font-family:tahoma;direction:rtl;box-shadow:0 10px 40px rgba(0,0,0,0.5);min-width:400px;";
        d.innerHTML = "<h2 style='margin:0 0 20px;font-size:22px;'>&#9940; " + TEXTS.expired + "</h2><p style='margin-top:20px;padding:15px;background:rgba(255,255,255,0.2);border-radius:8px;'>&#128222; Telegram: @YourUsername</p>";
        document.body.appendChild(d);
    }
    
    checkSub(function(sub){
        if(!sub.valid){ showExpired(); return; }
        
        if(window.__MS_RUN__){ alert(TEXTS.running + "!"); return; }
        window.__MS_RUN__ = true;
        
        var enabled = true;
        var autoSell = true;
        var sound = true;
        var interval = DEFAULT_INTERVAL;
        var threshold = DEFAULT_THRESHOLD;
        var bgWorker = null;
        var logBox = null;
        
        function $(s){ return document.querySelector(s); }
        function sleep(ms){ return new Promise(function(r){ setTimeout(r,ms); }); }
        
        /* ============================================
           Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Worker
           ============================================ */
        function createBackgroundTimer(callback, ms) {
            var workerCode = "var i=" + ms + ";setInterval(function(){postMessage('tick');},i);";
            var blob = new Blob([workerCode], {type: "application/javascript"});
            var worker = new Worker(URL.createObjectURL(blob));
            worker.onmessage = function(e) {
                if(e.data === "tick") callback();
            };
            return worker;
        }
        
        /* Ø­Ù„ Ø¨Ø¯ÙŠÙ„ Ø¥Ø°Ø§ Web Worker Ù„Ù… ÙŠØ¹Ù…Ù„ */
        function createFallbackTimer(callback, ms) {
            var lastTime = Date.now();
            function check() {
                var now = Date.now();
                if(now - lastTime >= ms) {
                    lastTime = now;
                    callback();
                }
                requestAnimationFrame(check);
            }
            requestAnimationFrame(check);
            
            /* Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù†Ø´Ø· */
            setInterval(function(){}, 1000);
            
            /* Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù†Ø¹ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù† Ø¥Ø¨Ø·Ø§Ø¡ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ */
            if(document.hidden !== undefined) {
                document.addEventListener("visibilitychange", function() {
                    if(document.hidden) {
                        console.log("[MS] Tab hidden - using alternative timer");
                    }
                });
            }
        }
        
        function log(m){
            var t = new Date().toLocaleTimeString();
            console.log("[MS]", t, m);
            if(logBox){
                var d = document.createElement("div");
                d.textContent = "[" + t + "] " + m;
                logBox.insertBefore(d, logBox.firstChild);
                while(logBox.children.length > 30) logBox.lastChild.remove();
            }
        }
        
        function beep(){
            if(!sound) return;
            try{
                var ctx = new (window.AudioContext || window.webkitAudioContext)();
                var osc = ctx.createOscillator();
                var gain = ctx.createGain();
                osc.type = "sine";
                osc.frequency.value = 550;
                gain.gain.value = 0.1;
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                setTimeout(function(){ osc.stop(); }, 180);
            }catch(e){}
        }
        
        function toNum(t){ return Number(String(t||"0").replace(/[^0-9]/g,"")); }
        
        function getMyRes(){
            return {
                wood: toNum($("#wood") ? $("#wood").textContent : 0),
                stone: toNum($("#stone") ? $("#stone").textContent : 0),
                iron: toNum($("#iron") ? $("#iron").textContent : 0)
            };
        }
        
        function getMarketVal(r){
            var divs = document.querySelectorAll(".premium-exchange-sep");
            for(var i=0; i<divs.length; i++){
                var d = divs[i];
                var img = d.querySelector("img");
                if(!img) continue;
                var src = img.src;
                if(r === "wood" && src.indexOf("wood_") !== -1) return toNum(d.textContent);
                if(r === "stone" && src.indexOf("stone_") !== -1) return toNum(d.textContent);
                if(r === "iron" && src.indexOf("iron_") !== -1) return toNum(d.textContent);
            }
            return null;
        }
        
        function getMerchants(){
            var el = $("#market_merchant_available_count");
            return el ? toNum(el.textContent) : 0;
        }
        
        function getSel(r){
            return {
                stock: $("#premium_exchange_stock_" + r),
                cap: $("#premium_exchange_capacity_" + r),
                input: $("input[name='sell_" + r + "']") || $("input[data-resource='" + r + "'][data-type='sell']")
            };
        }
        
        function updRes(){
            var res = getMyRes();
            var w = $("#ms-w"); var s = $("#ms-s"); var i = $("#ms-i");
            if(w) w.textContent = res.wood.toLocaleString();
            if(s) s.textContent = res.stone.toLocaleString();
            if(i) i.textContent = res.iron.toLocaleString();
        }
        
        async function sellRes(r){
            log(TEXTS.checking + " " + r + "...");
            var sel = getSel(r);
            if(!sel.stock || !sel.cap || !sel.input){ log(r + " not found"); return false; }
            
            var marketStock = toNum(sel.stock.textContent);
            var marketCap = toNum(sel.cap.textContent);
            var myRes = getMyRes();
            var myAmt = myRes[r] || 0;
            
            var marketNeed = (marketCap - marketStock) - BUFFER;
            if(marketNeed < 0) marketNeed = 0;
            
            var canSell = myAmt - RESOURCE_BUFFER;
            if(canSell < 0) canSell = 0;
            
            var qty = Math.min(marketNeed, canSell);
            
            var merchants = getMerchants();
            if(merchants <= 0){ log(TEXTS.noMerchants); return false; }
            
            var maxQty = merchants * MERCHANT_CAPACITY;
            qty = Math.min(qty, maxQty);
            
            if(qty <= 0){ log("qty = 0"); return false; }
            
            sel.input.focus();
            sel.input.value = qty;
            sel.input.dispatchEvent(new Event("input",{bubbles:true}));
            
            await sleep(CLICK_DELAY);
            
            var btn1 = $(".btn-premium-exchange-buy");
            if(!btn1){ log("btn not found"); return false; }
            btn1.click();
            
            await sleep(CLICK_DELAY);
            
            var btn2 = $(".btn-confirm-yes") || $("[class*='confirm']");
            if(!btn2){ log("confirm not found"); return false; }
            btn2.click();
            
            await sleep(CLICK_DELAY);
            
            beep();
            log(TEXTS.sold + "! " + qty + " " + r);
            return true;
        }
        
        async function autoSellCheck(){
            if(!enabled) return;
            log(TEXTS.checking + "...");
            updRes();
            
            var list = ["wood", "stone", "iron"];
            var labels = [TEXTS.wood, TEXTS.stone, TEXTS.iron];
            
            for(var i=0; i<list.length; i++){
                var r = list[i];
                var val = getMarketVal(r);
                if(val === null){ log(r + " val not found"); continue; }
                
                log(labels[i] + " = " + val + " | " + TEXTS.threshold + " = " + threshold);
                
                if(val <= threshold){
                    log(TEXTS.thresholdMet + " " + labels[i] + "!");
                    beep();
                    if(autoSell){
                        var ok = await sellRes(r);
                        if(ok) await sleep(BETWEEN_SELL_DELAY);
                    }
                }
            }
            log(TEXTS.done);
            updRes();
        }
        
        function startBackgroundTimer(){
            if(bgWorker) bgWorker.terminate();
            try {
                bgWorker = createBackgroundTimer(function(){
                    if(enabled && autoSell) autoSellCheck();
                }, interval);
                log("Web Worker " + TEXTS.background);
            } catch(e) {
                console.log("Web Worker failed, using fallback");
                createFallbackTimer(function(){
                    if(enabled && autoSell) autoSellCheck();
                }, interval);
                log("Fallback timer " + TEXTS.background);
            }
        }
        
        function buildUI(){
            if($("#ms-p")) return;
            var css = document.createElement("style");
            css.textContent = "#ms-p{position:fixed;left:20px;bottom:20px;z-index:999999;width:300px;padding:10px;border-radius:10px;background:rgba(0,0,0,0.9);color:#fff;font-family:tahoma;direction:rtl;font-size:12px}#ms-p h3{margin:0 0 8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.3);padding-bottom:6px;font-size:14px}#ms-p .inf{background:rgba(255,255,255,0.15);padding:5px;border-radius:5px;margin-bottom:6px;text-align:center;font-size:11px}#ms-p .bg-status{background:rgba(76,175,80,0.3);color:#8BC34A;padding:3px 6px;border-radius:3px;font-size:10px;display:inline-block;margin-top:4px}#ms-p .rs{background:rgba(255,255,255,0.1);padding:6px;border-radius:5px;margin-bottom:6px;font-size:11px}#ms-p .rs div{display:flex;justify-content:space-between;padding:2px 0}#ms-p .ck{margin:5px 0}#ms-p button{width:100%;margin:3px 0;padding:6px;border:none;border-radius:5px;font-weight:bold;cursor:pointer;font-size:11px}#ms-p .bt{background:#1e88e5;color:#fff}#ms-p .bt.off{background:#f44336}#ms-p .bn{background:#4CAF50;color:#fff}#ms-p .bi{background:#FF9800;color:#fff}#ms-p .bc{background:#666;color:#fff}#ms-p #ms-lg{max-height:100px;overflow-y:auto;background:rgba(255,255,255,0.08);padding:4px;font-size:10px;margin-top:5px;border-radius:3px}";
            document.head.appendChild(css);
            
            var box = document.createElement("div");
            box.id = "ms-p";
            box.innerHTML = "<h3>&#128176; " + TEXTS.title + " v5</h3>" +
                "<div class='inf'>&#128100; " + USER_NAME + " | &#9203; " + sub.days + " " + TEXTS.day + "<br><span class='bg-status'>&#9889; " + TEXTS.background + "</span></div>" +
                "<div class='rs'><div><span>&#129717; " + TEXTS.wood + ":</span><span id='ms-w' style='color:#8BC34A'>" + getMyRes().wood.toLocaleString() + "</span></div>" +
                "<div><span>&#129704; " + TEXTS.stone + ":</span><span id='ms-s' style='color:#FF9800'>" + getMyRes().stone.toLocaleString() + "</span></div>" +
                "<div><span>&#9881; " + TEXTS.iron + ":</span><span id='ms-i' style='color:#9E9E9E'>" + getMyRes().iron.toLocaleString() + "</span></div>" +
                "<div style='font-size:10px;color:#aaa;margin-top:4px'>&#128161; " + TEXTS.reserve + ": " + RESOURCE_BUFFER + "</div></div>" +
                "<div class='ck'><label><input type='checkbox' id='ms-au' checked> &#128260; " + TEXTS.autoSell + "</label></div>" +
                "<div class='ck'><label><input type='checkbox' id='ms-sn' checked> &#128266; " + TEXTS.sound + "</label></div>" +
                "<button class='bt' id='ms-tg'>&#9208; " + TEXTS.stop + "</button>" +
                "<button class='bn' id='ms-nw'>&#128640; " + TEXTS.runNow + "</button>" +
                "<button class='bi' id='ms-th'>&#127919; " + TEXTS.threshold + " (" + threshold + ")</button>" +
                "<button class='bi' id='ms-in'>&#9201; " + TEXTS.period + " (" + (interval/1000) + "s)</button>" +
                "<button class='bc' id='ms-cl'>&#10006; " + TEXTS.close + "</button>" +
                "<div id='ms-lg'>-- " + TEXTS.log + " --</div>";
            document.body.appendChild(box);
            
            logBox = $("#ms-lg");
            setInterval(updRes, 5000);
            
            $("#ms-tg").onclick = function(){
                enabled = !enabled;
                var b = $("#ms-tg");
                b.innerHTML = enabled ? "&#9208; " + TEXTS.stop : "&#9654; " + TEXTS.start;
                b.className = enabled ? "bt" : "bt off";
            };
            
            $("#ms-nw").onclick = function(){ autoSellCheck(); };
            
            $("#ms-th").onclick = function(){
                var v = prompt(TEXTS.threshold + ":", threshold);
                if(v){ threshold = Number(v); $("#ms-th").innerHTML = "&#127919; " + TEXTS.threshold + " (" + threshold + ")"; }
            };
            
            $("#ms-in").onclick = function(){
                var v = prompt(TEXTS.period + " (s):", interval/1000);
                if(v){ 
                    interval = Number(v)*1000; 
                    $("#ms-in").innerHTML = "&#9201; " + TEXTS.period + " (" + (interval/1000) + "s)"; 
                    startBackgroundTimer();
                }
            };
            
            $("#ms-au").onchange = function(e){ autoSell = e.target.checked; };
            $("#ms-sn").onchange = function(e){ sound = e.target.checked; };
            
            $("#ms-cl").onclick = function(){
                if(bgWorker) bgWorker.terminate();
                box.remove();
                window.__MS_RUN__ = false;
            };
        }
        
        buildUI();
        startBackgroundTimer();
        log(TEXTS.running + "!");
    });
})();
    `;
    
    const encoded = 'javascript:' + encodeURIComponent(bookmarkletCode.replace(/\s+/g, ' ').trim());
    document.getElementById('bookmarklet-link').href = encoded;
    </script>
</body>
</html>
