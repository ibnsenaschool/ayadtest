<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ØªÙ‚ÙˆÙŠÙ… (Ø¹Ø±Ø¶ Ù…Ù† Ù…Ù„Ù ÙÙ‚Ø·) â€” Ø§Ù„Ø£Ø­Ø¯â€“Ø§Ù„Ø®Ù…ÙŠØ³</title>
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#38bdf8; --ring:rgba(56,189,248,.35); }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic",Tahoma,sans-serif}
    .container{max-width:1100px;margin-inline:auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:center;margin-bottom:8px}
    .nav{display:flex;align-items:center;gap:8px}
    button{background:var(--panel);color:var(--text);border:1px solid #1f2937;border-radius:12px;padding:8px 12px;cursor:pointer}
    button:hover{outline:2px solid var(--ring)}
    .month-title{font-size:1.15rem;font-weight:800}

    /* Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø³Ø§Ø¹Ø© ÙÙˆÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ¨Ø§Ù„Ù…Ù†ØªØµÙ ÙˆÙ…Ù„Ø§ØµÙ‚ Ù„Ù‡ */
    .nowbar{display:flex;align-items:center;justify-content:center;gap:10px;margin:8px 0 6px 0}
    .nowbar .date{font-size:1.05rem;font-weight:800}
    .nowbar .time{font-variant-numeric:tabular-nums;color:var(--muted);font-weight:700}

    .calendar{background:rgba(255,255,255,0.03);border:1px solid #1e293b;border-radius:16px;overflow:hidden}
    .weekdays,.grid{display:grid;grid-template-columns:repeat(5,1fr)}
    .weekdays{background:rgba(255,255,255,.04);color:var(--muted);text-align:center;font-weight:700}
    .weekdays div{padding:10px 6px;border-inline-start:1px solid #1f2937}
    .weekdays div:first-child{border-inline-start:none}
    .grid{gap:10px;padding:12px}
    .day{min-height:110px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid #1f2937;border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:8px;position:relative}
    .day.today{border-color:var(--accent);box-shadow:0 0 0 2px var(--ring) inset}
    .day .num{font-weight:900}
    .events{display:flex;flex-direction:column;gap:6px}
    .event-chip{background:#0b3a2a;border:1px solid #14532d;color:#bef264;padding:6px 8px;border-radius:10px;font-size:.85rem;line-height:1.2;word-wrap:break-word}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px;color:var(--muted)}
    .status{margin-inline-start:auto;color:var(--muted);font-size:.9rem}
    .pill{border:1px dashed #334155;border-radius:999px;padding:6px 10px}
    @media (max-width:700px){.day{min-height:100px}.weekdays div{font-size:.9rem}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="nav">
        <button id="prevBtn" title="Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚">â—€</button>
        <div class="month-title" id="monthTitle"></div>
        <button id="nextBtn" title="Ø§Ù„Ø´Ù‡Ø± Ø§Ù„ØªØ§Ù„ÙŠ">â–¶</button>
      </div>
    </header>

    <!-- Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø³Ø§Ø¹Ø© ÙÙˆÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ¨Ø§Ù„Ù…Ù†ØªØµÙ -->
    <div class="nowbar" aria-live="polite">
      <div class="date" id="currentDate"></div>
      <div class="time" id="currentTime"></div>
    </div>

    <section class="calendar">
      <div class="weekdays">
        <div>Ø§Ù„Ø£Ø­Ø¯</div><div>Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</div><div>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</div><div>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</div><div>Ø§Ù„Ø®Ù…ÙŠØ³</div>
      </div>
      <div id="grid" class="grid"></div>
    </section>

    <div class="toolbar">
      <span class="pill">ÙˆØ¶Ø¹ Ø¹Ø±Ø¶ ÙÙ‚Ø·: Ø§Ù„Ù…ØµØ¯Ø± <code>events.json</code> Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ù…Ù„Ù ØªØ®ØªØ§Ø±Ù‡ (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·).</span>
      <button id="pickFile">ğŸ“‚ Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª (JSON)</button>
      <button id="refreshBtn">âŸ³ ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ù…Ù„Ù</button>
      <span class="status" id="status">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯ â€” Ø³ÙŠØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© <code>events.json</code> Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ØµÙØ­Ø©</span>
      <button id="runTestsBtn" style="margin-inline-start:auto">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
    </div>
  </div>

  <script>
    // ======= ÙˆØ¶Ø¹ Ø¹Ø±Ø¶ ÙÙ‚Ø·: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ø­ÙØ¸/Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© =======

    // ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¨Ø£Ø±Ù‚Ø§Ù… Ù„Ø§ØªÙŠÙ†ÙŠØ© (0..9)
    const DTF_DATE = new Intl.DateTimeFormat('ar-EG-u-nu-latn', {weekday:'long', day:'2-digit', month:'long', year:'numeric'});
    const DTF_TIME = new Intl.DateTimeFormat('ar-EG-u-nu-latn', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    const fmtMonth = (y, m) => new Intl.DateTimeFormat('ar-EG-u-nu-latn',{month:'long', year:'numeric'}).format(new Date(y, m, 1));

    const state = {
      viewYear: (new Date()).getFullYear(),
      viewMonth: (new Date()).getMonth(),
      events: {},                 // { 'YYYY-MM-DD': [ {title,time,notes} ] }
      readHandle: null            // FileSystemFileHandle Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
    };

    function toISO(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10); }

    function tickNow(){
      const now = new Date();
      document.getElementById('currentDate').textContent = DTF_DATE.format(now);
      document.getElementById('currentTime').textContent = DTF_TIME.format(now);
    }
    tickNow(); setInterval(tickNow, 1000);

    async function tryReadLocalJSON(){
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© events.json Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ØµÙØ­Ø© (GitHub Pages)
      try{
        const res = await fetch('events.json', {cache:'no-store'});
        if(res.ok){
          const data = await res.json();
          if(data && typeof data==='object'){ state.events = data; render(); setStatus('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† events.json Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ØµÙØ­Ø©'); }
        } else {
          setStatus('Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ events.json Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ØµÙØ­Ø©');
        }
      }catch(e){ setStatus('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ: ' + e.message); }
    }

    async function pickFile(){
      if(!('showOpenFilePicker' in window)){
        alert('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù…Ø­Ù„ÙŠ. Ø§Ø³ØªØ®Ø¯Ù… ÙƒØ±ÙˆÙ…/Ø¥ÙŠØ¯Ø¬ Ø­Ø¯ÙŠØ« Ø£Ùˆ Ø¶Ø¹ events.json Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ØµÙØ­Ø©.');
        return;
      }
      try{
        const [h] = await window.showOpenFilePicker({
          multiple:false,
          types:[{description:'Events JSON', accept:{'application/json':['.json']}}]
        });
        state.readHandle = h;
        await refreshFromHandle();
      }catch(e){ if(e?.name!=='AbortError') setStatus('ÙØ´Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù: ' + e.message); }
    }

    async function refreshFromHandle(){
      if(!state.readHandle){ setStatus('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù…Ø±ØªØ¨Ø· â€” Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… events.json Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ØµÙØ­Ø© Ø¥Ù† ÙˆØ¬Ø¯'); await tryReadLocalJSON(); return; }
      try{
        const file = await state.readHandle.getFile();
        const data = JSON.parse(await file.text()||'{}') || {};
        if(typeof data !== 'object') throw new Error('JSON ØºÙŠØ± ØµØ§Ù„Ø­');
        state.events = data; render(); setStatus('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ù…Ù„Ù: ' + (state.readHandle.name || 'events.json'));
      }catch(e){ setStatus('ÙØ´Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ù: ' + e.message); }
    }

    function setStatus(msg){ document.getElementById('status').textContent = msg; }

    function render(){
      document.getElementById('monthTitle').textContent = fmtMonth(state.viewYear, state.viewMonth);
      const grid = document.getElementById('grid'); grid.innerHTML = '';
      const last = new Date(state.viewYear, state.viewMonth + 1, 0);
      const todayISO = toISO(new Date());
      for(let day=1; day<=last.getDate(); day++){
        const d = new Date(state.viewYear, state.viewMonth, day);
        const dow = d.getDay();
        if(dow===5 || dow===6) continue; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ù…Ø¹Ø© ÙˆØ§Ù„Ø³Ø¨Øª
        const iso = toISO(d);
        const cell = document.createElement('div');
        cell.className = 'day' + (iso===todayISO ? ' today' : '');
        const num = document.createElement('div'); num.className='num'; num.textContent = String(day).padStart(2,'0');
        const list = document.createElement('div'); list.className='events';
        const evts = state.events[iso] || [];
        // Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„Ù…Ù„Ù â€” Ù„Ø§ Ø¥Ø¶Ø§ÙØ© ÙˆÙ„Ø§ ØªØ¹Ø¯ÙŠÙ„
        evts.forEach(e=>{
          const chip=document.createElement('div'); chip.className='event-chip';
          chip.textContent=(e.time?(e.time+' â€” '):'')+(e.title||'');
          chip.title=e.notes||''; list.appendChild(chip);
        });
        cell.append(num,list); grid.appendChild(cell);
      }
    }

    // ØªÙ†Ù‚Ù„ Ø§Ù„Ø£Ø´Ù‡Ø±
    document.getElementById('prevBtn').addEventListener('click', ()=>{ const m=state.viewMonth-1; if(m<0){state.viewMonth=11;state.viewYear-=1;} else state.viewMonth=m; render(); });
    document.getElementById('nextBtn').addEventListener('click', ()=>{ const m=state.viewMonth+1; if(m>11){state.viewMonth=0;state.viewYear+=1;} else state.viewMonth=m; render(); });

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª
    document.getElementById('pickFile').addEventListener('click', pickFile);
    document.getElementById('refreshBtn').addEventListener('click', refreshFromHandle);

    // Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ø³ÙŠØ·Ø© (Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸)
    document.getElementById('runTestsBtn').addEventListener('click', ()=>{
      try{
        // TC1: Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£ÙŠ Ø¯Ø§Ù„Ø© Ø­ÙØ¸/ÙƒØªØ§Ø¨Ø©
        const hasWrite = /createWritable|write\(/.test(document.querySelector('script').textContent) === false;
        if(!hasWrite) throw new Error('ÙŠØ¬Ø¨ Ø£Ù† Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ§Ø¨Ø© Ù„Ù„Ù…Ù„ÙØ§Øª ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·');

        // TC2: Ø§Ù„Ø£Ø±Ù‚Ø§Ù… 0-9 ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª (Ù„Ø§ØªÙŠÙ†ÙŠØ©)
        const t1 = document.getElementById('currentDate').textContent + ' ' + document.getElementById('currentTime').textContent;
        if(/[Ù -Ù©]/.test(t1)) throw new Error('Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„ÙŠØ³Øª Ù„Ø§ØªÙŠÙ†ÙŠØ© ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶');

        // TC3: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ù…Ø¹Ø© ÙˆØ§Ù„Ø³Ø¨Øª
        const days = Array.from({length:new Date(state.viewYear, state.viewMonth+1,0).getDate()},(_,i)=> new Date(state.viewYear,state.viewMonth,i+1).getDay());
        if(days.includes(5) || days.includes(6)){
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨ØµØ±ÙŠ ÙÙ‚Ø·: Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ù…Ø±Ø³ÙˆÙ…Ø© ÙŠØ¬Ø¨ Ø£Ù„Ø§ ØªØ´Ù…Ù„ Ø£ÙŠØ§Ù… (5,6)
        }

        alert('âœ… Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· Ù†Ø¬Ø­Øª');
      }catch(e){ alert('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª: '+e.message); }
    });

    (async function init(){ await tryReadLocalJSON(); render(); tickNow(); })();
  </script>
</body>
</html>
