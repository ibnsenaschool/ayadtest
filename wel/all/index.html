<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>عارض وسائط (wel/all)</title>
  <meta name="description" content="عارض وسائط يعمل على GitHub Pages لمسار wel/all. يدعم صور/فيديو/PDF/PPTX."/>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:#000;color:#fff;overflow:hidden}
    .app{position:relative;width:100vw;height:100vh;display:grid;grid-template-rows:auto 1fr auto}
    header,footer{padding:12px 16px;background:rgba(255,255,255,0.05)}
    header{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .left,.right{display:flex;gap:8px;align-items:center}
    .brand{font-weight:700;opacity:.9}
    .viewer{position:relative;width:100%;height:100%;display:grid;align-items:center;justify-items:center;background:#000}
    .slide{position:absolute;inset:0;display:none}
    .slide.active{display:block}
    .slide img,.slide video,.slide object,.slide iframe{width:100%;height:100%;object-fit:contain;background:#000}
    .controls{position:absolute;inset-inline:16px;bottom:16px;display:flex;align-items:center;gap:10px;justify-content:center;background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.15);padding:8px 12px;border-radius:12px;backdrop-filter:blur(4px)}
    button,label.btn{background:rgba(255,255,255,0.12);color:#fff;border:1px solid rgba(255,255,255,0.25);padding:8px 12px;border-radius:10px;cursor:pointer;font-size:14px;transition:transform .15s ease,background .2s ease}
    button:hover,label.btn:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}
    .time{opacity:.85;min-width:110px;text-align:center}
    .progress-wrap{flex:1;height:6px;background:rgba(255,255,255,0.15);border-radius:6px;overflow:hidden}
    .progress{height:100%;width:0%;background:linear-gradient(90deg,#667eea,#764ba2)}
    .info{position:absolute;top:16px;inset-inline:16px;display:flex;justify-content:space-between;align-items:center;gap:10px;background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.15);padding:8px 12px;border-radius:12px;backdrop-filter:blur(4px)}
    .counter{opacity:.85;font-size:14px}
    .filename{font-weight:600;max-width:70vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .nav-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.15);border:none;color:#fff;font-size:36px;padding:8px 12px;border-radius:10px;cursor:pointer}
    .nav-btn:hover{background:rgba(255,255,255,0.28)}
    .prev{inset-inline-start:16px}.next{inset-inline-end:16px}
    .hint{opacity:.8;font-size:13px}
    .hidden{display:none!important}
    @media (max-width:768px){.filename{max-width:55vw}.nav-btn{font-size:28px}}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="left">
        <span class="brand">🎬 عارض (wel/all)</span>
        <span class="hint">ضع الوسائط بجانب هذا الملف في نفس المجلد. التحديث تلقائي عبر manifest.json.</span>
      </div>
      <div class="right">
        <button id="reloadBtn" title="إعادة تحميل القائمة">🔄 تحديث</button>
        <span class="hint">يدعم صور/فيديو/PDF/PPT/PPTX</span>
      </div>
    </header>

    <main class="viewer">
      <div class="info">
        <div class="filename" id="fileName">—</div>
        <div class="counter" id="counter">0 / 0</div>
      </div>

      <button class="nav-btn prev" id="prevBtn" title="السابق">‹</button>
      <button class="nav-btn next" id="nextBtn" title="التالي">›</button>

      <div id="slides"></div>

      <div class="controls">
        <button id="playPause">⏸️ إيقاف</button>
        <button id="muteUnmute" class="hidden">🔇 كتم</button>
        <div class="time" id="timeLabel">0:00 / 0:00</div>
        <div class="progress-wrap"><div class="progress" id="progress"></div></div>
        <label for="speedRange">⏱️</label>
        <input id="speedRange" type="range" min="1" max="15" step="1" value="5" />
        <span id="speedValue">5s</span>
        <button id="loopToggle">🔁 تكرار</button>
        <button id="shuffleToggle">🔀 خلط</button>
      </div>
    </main>

    <footer><div class="hint">اختصارات: ←/→ تنقّل، Space تشغيل/إيقاف، M كتم، L تكرار، S خلط، R تحديث.</div></footer>
  </div>

  <script>
  (function(){
    'use strict';
    const IMAGE_EXT = ['.jpg','.jpeg','.png','.webp','.gif','.bmp'];
    const VIDEO_EXT = ['.mp4','.webm','.ogg'];
    const PDF_EXT   = ['.pdf'];
    const PPT_EXT   = ['.ppt','.pptx'];
    const DEFAULT_DURATION = 5000;
    const PROGRESS_INTERVAL = 100;

    let slides = []; let index=0; let playing=true; let looping=false; let shuffled=false;
    let timer=null; let progressTimer=null; let duration=DEFAULT_DURATION;
    let videoEl=null; let currentSlideEl=null;

    const elSlides = document.getElementById('slides');
    const elCounter = document.getElementById('counter');
    const elFileName = document.getElementById('fileName');
    const elPlayPause = document.getElementById('playPause');
    const elMute = document.getElementById('muteUnmute');
    const elPrev = document.getElementById('prevBtn');
    const elNext = document.getElementById('nextBtn');
    const elSpeed = document.getElementById('speedRange');
    const elSpeedVal = document.getElementById('speedValue');
    const elProgress = document.getElementById('progress');
    const elTimeLabel = document.getElementById('timeLabel');
    const elLoop = document.getElementById('loopToggle');
    const elShuffle = document.getElementById('shuffleToggle');
    const elReload = document.getElementById('reloadBtn');

    const extOf = (name) => name.slice(name.lastIndexOf('.')).toLowerCase();
    const isImage = (name) => IMAGE_EXT.includes(extOf(name));
    const isVideo = (name) => VIDEO_EXT.includes(extOf(name));
    const isPdf   = (name) => PDF_EXT.includes(extOf(name));
    const isPpt   = (name) => PPT_EXT.includes(extOf(name));
    const fmtTime = (sec) => { if(isNaN(sec)||sec===Infinity) return '0:00'; const m=Math.floor(sec/60), s=Math.floor(sec%60); return m+':'+(s<10?'0'+s:s); };
    const naturalCompare = (a,b) => a.name.localeCompare(b.name, undefined, { numeric:true, sensitivity:'base' });

    function clearTimers(){ if(timer){clearTimeout(timer);timer=null;} if(progressTimer){clearInterval(progressTimer);progressTimer=null;} }
    function resetProgress(){ elProgress.style.width='0%'; elTimeLabel.textContent='0:00 / 0:00'; }
    function updateCounter(){ elCounter.textContent=(slides.length?(index+1):0)+' / '+slides.length; elFileName.textContent=slides.length?(slides[index].name||'—'):'—'; }

    function buildSlideElement(item){
      const slide=document.createElement('div'); slide.className='slide';
      if(item.type==='image'){
        const img=document.createElement('img'); img.src=item.url; img.alt=item.name||''; slide.appendChild(img);
      } else if(item.type==='video'){
        const v=document.createElement('video'); v.src=item.url; v.controls=false; v.autoplay=true; v.loop=false; v.muted=true; v.playsInline=true; slide.appendChild(v);
      } else if(item.type==='pdf'){
        const obj=document.createElement('object'); obj.data=item.url+'#toolbar=1&navpanes=0&scrollbar=0'; obj.type='application/pdf'; obj.width='100%'; obj.height='100%';
        const alt=document.createElement('div'); alt.style.padding='20px'; alt.style.textAlign='center'; alt.innerHTML='إذا لم يظهر الـ PDF <a href="'+item.url+'" target="_blank" style="color:#8ab4f8">افتحه في تبويب</a>'; obj.appendChild(alt); slide.appendChild(obj);
      } else if(item.type==='ppt'){
        const abs = item.absUrl || item.url;
        const office = 'https://view.officeapps.live.com/op/embed.aspx?src=' + encodeURIComponent(abs);
        const ifr=document.createElement('iframe'); ifr.src=office; ifr.allowFullscreen=true; ifr.frameBorder='0';
        slide.appendChild(ifr);
      }
      return slide;
    }

    function mountCurrentSlide(){
      while(elSlides.firstChild) elSlides.removeChild(elSlides.firstChild);
      videoEl=null; currentSlideEl=null; resetProgress();
      if(!slides.length) return;

      const item=slides[index];
      const slide=buildSlideElement(item);
      slide.classList.add('active');
      elSlides.appendChild(slide);
      currentSlideEl=slide;

      if(item.type==='video'){
        videoEl=slide.querySelector('video'); elMute.classList.remove('hidden');
        videoEl.addEventListener('timeupdate', ()=>{
          const cur=videoEl.currentTime||0, dur=videoEl.duration||0, p=dur?(cur/dur)*100:0;
          elProgress.style.width=p+'%'; elTimeLabel.textContent=fmtTime(cur)+' / '+fmtTime(dur);
        });
        videoEl.addEventListener('ended', onAutoAdvance);
        videoEl.play().catch(()=>{});
      } else {
        elMute.classList.add('hidden');
        const ms=duration, start=Date.now();
        progressTimer=setInterval(()=>{
          const p=Math.min(100, ((Date.now()-start)/ms)*100);
          elProgress.style.width=p+'%';
          elTimeLabel.textContent=fmtTime((Date.now()-start)/1000)+' / '+fmtTime(ms/1000);
        }, PROGRESS_INTERVAL);
        timer=setTimeout(onAutoAdvance, ms);
      }
      updateCounter();
    }

    function onAutoAdvance(){ clearTimers(); if(!playing) return; goNext(); }
    function goNext(){ if(!slides.length) return; if(index<slides.length-1){ index+=1; } else { if(looping) index=0; else { playing=false; updatePlayButton(); return; } } mountCurrentSlide(); }
    function goPrev(){ if(!slides.length) return; if(index>0){ index-=1; } else { if(looping) index=slides.length-1; else { index=0; } } mountCurrentSlide(); }
    function updatePlayButton(){ elPlayPause.textContent = playing ? '⏸️ إيقاف' : '▶️ تشغيل'; }
    function togglePlay(){ playing=!playing; updatePlayButton(); if(playing){ if(slides[index]?.type==='video'&&videoEl){ videoEl.play().catch(()=>{});} else { mountCurrentSlide(); } } else { if(videoEl) videoEl.pause(); clearTimers(); } }
    function toggleMute(){ if(!videoEl) return; videoEl.muted=!videoEl.muted; elMute.textContent = videoEl.muted ? '🔇 كتم' : '🔊 صوت'; }
    function toggleLoop(){ looping=!looping; elLoop.textContent = looping ? '🔁 تكرار ✓' : '🔁 تكرار'; }
    function toggleShuffle(){ shuffled=!shuffled; elShuffle.textContent = shuffled ? '🔀 خلط ✓' : '🔀 خلط'; if(shuffled) shuffleSlides(); else slides.sort((a,b)=>a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'})); index=0; mountCurrentSlide(); }
    function shuffleSlides(){ for(let i=slides.length-1;i>0;i++){ const j=Math.floor(Math.random()*(i+1)); [slides[i],slides[j]]=[slides[j],slides[i]]; } }
    function setDurationFromUI(val){ const seconds=parseInt(val,10)||5; duration=Math.max(1,seconds)*1000; elSpeedVal.textContent=seconds+'s'; }

    async function loadManifest(){
      const res = await fetch('manifest.json', { cache: 'no-store' });
      if(!res.ok) throw new Error('تعذر تحميل manifest.json من wel/all');
      const list = await res.json();
      slides = []; index = 0;

      // قاعدة الرابط المطلق لملفات PPT/PPTX (مطلوب لـ Office Viewer)
      // مثالك: https://ibnsenaschool.github.io/ayadtest/wel/all/
      const origin = location.origin;
      // المسار الأساسي حتى wel/all/
      const basePath = location.pathname.replace(/\\/wel\\/all\\/.*$/, '/wel/all/').replace(/(\\/wel\\/all\\/)?$/, '/wel/all/');
      const baseAbs = origin + basePath;

      list.forEach((item)=>{
        if(!item || !item.url) return;
        const name = item.name || item.url.split('/').pop();
        const ext = (name.slice(name.lastIndexOf('.')) || '').toLowerCase();
        let type = null;
        if (IMAGE_EXT.includes(ext)) type='image';
        else if (VIDEO_EXT.includes(ext)) type='video';
        else if (PDF_EXT.includes(ext)) type='pdf';
        else if (PPT_EXT.includes(ext)) type='ppt';
        if (!type) return;
        const relUrl = item.url.startsWith('http') ? item.url : (basePath + item.url.replace(/^\\.\\//,''));
        const absUrl = item.url.startsWith('http') ? item.url : (baseAbs + item.url.replace(/^\\.\\//,''));
        slides.push({ type, name, url: relUrl, absUrl });
      });

      slides.sort((a,b)=>a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'}));
      playing = true; updatePlayButton(); mountCurrentSlide();
    }

    document.getElementById('prevBtn').addEventListener('click', ()=>{ clearTimers(); goPrev(); });
    document.getElementById('nextBtn').addEventListener('click', ()=>{ clearTimers(); goNext(); });
    document.getElementById('playPause').addEventListener('click', togglePlay);
    document.getElementById('muteUnmute').addEventListener('click', toggleMute);
    document.getElementById('loopToggle').addEventListener('click', toggleLoop);
    document.getElementById('shuffleToggle').addEventListener('click', toggleShuffle);
    document.getElementById('speedRange').addEventListener('input', (e)=> setDurationFromUI(e.target.value));
    document.getElementById('reloadBtn').addEventListener('click', ()=> loadManifest().catch(err=>alert(err.message)));

    document.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowLeft'){ clearTimers(); goPrev(); }
      if(e.key==='ArrowRight'){ clearTimers(); goNext(); }
      if(e.key===' '){ e.preventDefault(); togglePlay(); }
      if(e.key.toLowerCase()==='m') toggleMute();
      if(e.key.toLowerCase()==='l') toggleLoop();
      if(e.key.toLowerCase()==='s') toggleShuffle();
      if(e.key.toLowerCase()==='r') loadManifest().catch(err=>alert(err.message));
    });

    setDurationFromUI(document.getElementById('speedRange').value);
    loadManifest().catch(err=>{ console.warn(err); });
  })();
  </script>
</body>
</html>
