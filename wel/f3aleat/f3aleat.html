<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ألبوم الصور والفيديو</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b0b0c; --fg:#f5f7fb; --accent:#3b82f6; --pill:#1b1d23;
      --radius:16px; --shadow:0 6px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg);overflow:hidden}
    .stage{width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:#0f1115;position:relative;overflow:hidden}
    img,video{max-width:100%;max-height:100%;object-fit:contain;border-radius:var(--radius);box-shadow:var(--shadow)}
    .caption{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);padding:6px 10px;border-radius:8px;font-size:.9rem}
    .center-title{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);padding:10px 16px;border-radius:12px;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);font-weight:700;letter-spacing:.3px;text-align:center;box-shadow:var(--shadow)}
    .center-title span{display:block;font-size:clamp(16px,3.5vw,28px)}

    /* عناصر تحكم خفيفة للسرعة */
    .controls{position:absolute;right:12px;bottom:12px;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:8px 10px;display:flex;align-items:center;gap:8px}
    .controls label{font-size:.85rem;opacity:.9}
    .controls input[type=range]{width:140px}
    .btn{appearance:none;border:none;border-radius:10px;padding:8px 10px;background:var(--pill);color:var(--fg);cursor:pointer;border:1px solid rgba(255,255,255,.08)}
    .btn.toggle{min-width:74px;text-align:center}
    @media(max-width:600px){.controls{left:50%;right:auto;transform:translateX(-50%);bottom:10px}.controls input[type=range]{width:120px}}
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <img id="mediaImage" alt="صورة" style="display:none;" />
    <video id="mediaVideo" controls style="display:none;"></video>
    <div class="center-title"><span>يوم الزيت والزيتون - مدرسة ابن سينا</span></div>
    <div class="caption" id="caption"></div>

    <!-- عناصر تحكم بسيطة: سرعة + تشغيل/إيقاف -->
    <div class="controls">
      <button class="btn toggle" id="playPause" aria-pressed="true">إيقاف</button>
      <label for="speed">السرعة</label>
      <input id="speed" type="range" min="1" max="12" value="5" />
      <span id="speedVal" aria-hidden="true">5s</span>
    </div>
  </div>

  <script>
    // يدعم صور JPG/PNG/WEBP وفيديوهات MP4/WEBM/MOV
    const CONFIG={interval:5000};
    let items=[];

    async function loadList(){
      try{
        const res=await fetch('manifest.json',{cache:'no-store'});
        if(res.ok){
          const arr=await res.json();
          if(Array.isArray(arr)) return arr.filter(x=>typeof x==='string');
        }
      }catch{}
      // fallback: 1..20 صور jpg
      return Array.from({length:20},(_,i)=>`${i+1}.jpg`);
    }

    const img=document.getElementById('mediaImage');
    const vid=document.getElementById('mediaVideo');
    const caption=document.getElementById('caption');
    const stage=document.getElementById('stage');
    const playPause=document.getElementById('playPause');
    const speedRange=document.getElementById('speed');
    const speedVal=document.getElementById('speedVal');

    let idx=0, timer=null, intervalMs=CONFIG.interval;

    function isVideo(src){
      const ext=src.split('.').pop().toLowerCase();
      return ['mp4','webm','mov'].includes(ext);
    }

    function showItem(i){
      const src=items[i];
      if(!src) return;
      if(isVideo(src)){
        img.style.display='none';
        vid.style.display='block';
        if(vid.src!==src){ vid.src=src; }
        vid.play().catch(()=>{});
      }else{
        try{ vid.pause(); }catch{}
        vid.style.display='none';
        img.style.display='block';
        if(img.src!==src){ img.src=src; }
      }
      caption.textContent=src + ` — (${i+1}/${items.length})`;
      // تحميل مسبق للآتي
      const nextIndex=(i+1)%items.length; const pre=new Image(); if(!isVideo(items[nextIndex])) pre.src=items[nextIndex];
    }

    function next(){ idx=(idx+1)%items.length; showItem(idx); }
    function prev(){ idx=(idx-1+items.length)%items.length; showItem(idx); }

    function startTimer(){ stopTimer(); timer=setInterval(()=>{
      if(vid.style.display==='block' && !vid.ended && !vid.paused) return; // لا تتقدم أثناء تشغيل الفيديو
      next();
    }, intervalMs); }
    function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }

    function togglePlay(){
      const on = playPause.getAttribute('aria-pressed')==='true';
      if(on){ // إيقاف
        playPause.setAttribute('aria-pressed','false'); playPause.textContent='تشغيل'; stopTimer(); try{ vid.pause(); }catch{}
      }else{ // تشغيل
        playPause.setAttribute('aria-pressed','true'); playPause.textContent='إيقاف'; startTimer(); if(vid.style.display==='block'){ vid.play().catch(()=>{}); }
      }
    }

    // سرعة الانتقال
    function updateSpeed(){
      const s = Math.max(1, Math.min(12, +speedRange.value||5));
      speedVal.textContent = s+'s';
      intervalMs = s*1000;
      if(playPause.getAttribute('aria-pressed')==='true'){ startTimer(); }
      localStorage.setItem('albumSpeed', String(s));
    }

    // تفاعل لوحة المفاتيح
    window.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowLeft'){ prev(); }
      if(e.key==='ArrowRight'){ next(); }
      if(e.key===' '){ e.preventDefault(); togglePlay(); }
    });

    // سحب باللمس للتالي/السابق
    let touchX=null; let touchY=null;
    stage.addEventListener('touchstart', (e)=>{ touchX=e.touches[0].clientX; touchY=e.touches[0].clientY; }, {passive:true});
    stage.addEventListener('touchend', (e)=>{
      if(touchX==null) return;
      const dx=e.changedTouches[0].clientX - touchX;
      const dy=e.changedTouches[0].clientY - touchY;
      if(Math.abs(dx)>40 && Math.abs(dx)>Math.abs(dy)){
        dx>0 ? prev() : next();
      }
      touchX=touchY=null;
    }, {passive:true});

    playPause.addEventListener('click', togglePlay);
    speedRange.addEventListener('input', updateSpeed);

    async function start(){
      // استعادة السرعة
      const saved = +localStorage.getItem('albumSpeed');
      if(!isNaN(saved) && saved>=1 && saved<=12){ speedRange.value=String(saved); }
      updateSpeed();

      items = await loadList();
      if(!items.length){ caption.textContent='لا توجد ملفات.'; return; }
      showItem(idx);
      // تشغيل تلقائي افتراضيًا
      playPause.setAttribute('aria-pressed','true');
      playPause.textContent='إيقاف';
      startTimer();
    }

    start();
  </script>
</body>
</html>
