<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªÙÙˆÙ‚ÙŠÙ†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea, #764ba2);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      background: #fff;
      padding: 20px 25px;
      border-radius: 18px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      margin-bottom: 20px;
    }

    .header-title {
      font-size: 1.8em;
      color: #4f46e5;
      margin-bottom: 5px;
    }

    .header-sub {
      color: #555;
      font-size: 0.95em;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .github-status {
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: bold;
      color: #fff;
      font-size: 0.9em;
    }

    .github-status.off {
      background: #b91c1c;
    }

    .github-status.on {
      background: #15803d;
    }

    .btn {
      border: none;
      border-radius: 10px;
      padding: 8px 14px;
      font-size: 0.9em;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-primary {
      background: #22c55e;
      color: #fff;
    }

    .btn-primary:hover {
      background: #16a34a;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #4f46e5;
      color: #fff;
    }

    .btn-secondary:hover {
      background: #4338ca;
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Message */
    .message {
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      font-size: 0.9em;
      display: none;
    }

    .message.show {
      display: block;
    }

    .message.info {
      background: #e0f2fe;
      color: #1e3a8a;
    }

    .message.error {
      background: #fee2e2;
      color: #b91c1c;
    }

    .message.success {
      background: #dcfce7;
      color: #166534;
    }

    /* Main box */
    .main-box {
      margin-top: 20px;
      background: #fff;
      padding: 20px;
      border-radius: 18px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
    }

    .field-group {
      margin-bottom: 15px;
    }

    .label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
      color: #374151;
      font-size: 0.95em;
    }

    .select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 2px solid #e5e7eb;
      font-size: 0.95em;
      outline: none;
    }

    .select:focus {
      border-color: #4f46e5;
    }

    .students-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .students-header-row h2 {
      font-size: 1.1em;
      color: #374151;
    }

    .btn-add {
      background: #22c55e;
      color: #fff;
    }

    .btn-add:hover {
      background: #16a34a;
    }

    /* Student cards */
    .students-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }

    .student-card {
      border-radius: 18px;
      padding: 14px;
      background: linear-gradient(145deg, #ffffff, #f5f3ff);
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      border: 2px solid #e5e7eb;
      position: relative;
    }

    .student-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .photo-frame {
      width: 70px;
      height: 70px;
      border-radius: 16px;
      border: 3px solid #a855f7;
      overflow: hidden;
      background: #f3e8ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      color: #a855f7;
    }

    .photo-frame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .student-basic-info {
      flex: 1;
    }

    .student-basic-info .small-label {
      font-size: 0.8em;
      color: #6b7280;
      margin-bottom: 2px;
    }

    .student-basic-info input {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1.8px solid #e5e7eb;
      font-size: 0.9em;
      outline: none;
    }

    .student-basic-info input:focus {
      border-color: #4f46e5;
    }

    .field-row {
      margin-bottom: 7px;
    }

    .student-card-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-small {
      flex: 1;
      border-radius: 8px;
      padding: 7px 10px;
      font-size: 0.85em;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }

    .btn-photo {
      background: #4f46e5;
      color: #fff;
    }

    .btn-photo:hover {
      background: #4338ca;
    }

    .btn-delete {
      background: #ef4444;
      color: #fff;
    }

    .btn-delete:hover {
      background: #b91c1c;
    }

    .no-students {
      margin-top: 10px;
      font-size: 0.9em;
      color: #6b7280;
      text-align: center;
    }

    /* Cropper modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 18px;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .modal-title {
      text-align: center;
      font-size: 1.1em;
      font-weight: bold;
      margin-bottom: 10px;
      color: #4f46e5;
    }

    .crop-container {
      width: 260px;
      height: 260px;
      border-radius: 50%;
      border: 3px solid #4f46e5;
      margin: 0 auto 12px;
      overflow: hidden;
      position: relative;
      background: #f3f4f6;
    }

    .crop-image {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      user-select: none;
      cursor: move;
    }

    .modal-footer {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    .modal-footer .btn {
      flex: 1;
    }

    #zoomSlider {
      width: 100%;
      margin-bottom: 10px;
    }

    @media (max-width: 600px) {
      .students-list {
        grid-template-columns: 1fr;
      }
    }

  </style>
</head>
<body>

<div class="container">

  <!-- Header -->
  <div class="header">
    <div class="header-title">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªÙÙˆÙ‚ÙŠÙ†</div>
    <div class="header-sub">Ø§Ø®ØªÙØ± Ø§Ù„ØµÙ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø«Ù… Ø£Ø¶ÙÙ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ¹Ø¯Ù‘Ù„ Ø£Ø³Ù…Ø§Ø¡Ù‡Ù… ÙˆØµÙˆØ±Ù‡Ù… ÙˆÙ…Ø¹Ø¯Ù„Ø§ØªÙ‡Ù….</div>

    <div class="top-row">
      <div id="githubStatus" class="github-status off">
        ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù€ GitHub
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-secondary" onclick="openSettings()">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub</button>
        <button class="btn btn-primary" id="btnLoad" onclick="loadFromGitHub()" disabled>ğŸ“¥ ØªØ­Ù…ÙŠÙ„</button>
        <button class="btn btn-primary" id="btnSave" onclick="saveToGitHub()" disabled>ğŸ’¾ Ø­ÙØ¸</button>
      </div>
    </div>

    <div id="messageBox" class="message info">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ù‚Ø¨Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub.</div>
  </div>

  <!-- Main Box -->
  <div class="main-box">
    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ -->
    <div class="field-group">
      <label class="label">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ / Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
      <select id="classSelect" class="select"></select>
    </div>

    <div class="students-header-row">
      <h2 id="currentClassTitle">Ø§Ù„ØµÙ:</h2>
      <button class="btn btn-add" onclick="addStudentToCurrentClass()">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
    <div id="studentsContainer" class="students-list"></div>
    <div id="noStudentsMsg" class="no-students" style="display:none;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØµÙ.</div>
  </div>

</div>

<!-- Cropper Modal -->
<div id="cropperModal" class="modal">
  <div class="modal-content">
    <div class="modal-title">âœ‚ï¸ Ù‚Øµ Ø§Ù„ØµÙˆØ±Ø© ÙˆØªØ¹Ø¯ÙŠÙ„Ù‡Ø§</div>
    <div class="crop-container">
      <img id="cropImage" class="crop-image" src="">
    </div>
    <input type="range" id="zoomSlider" min="50" max="200" value="100">

    <div class="modal-footer">
      <button class="btn btn-primary" onclick="applyCrop()">ØªØ·Ø¨ÙŠÙ‚</button>
      <button class="btn btn-secondary" onclick="closeCropper()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<script>
  // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØµÙÙˆÙ
  const gradeGroups = {
    "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«": ["Ø§Ù„Ø«Ø§Ù„Ø« 1", "Ø§Ù„Ø«Ø§Ù„Ø« 2", "Ø§Ù„Ø«Ø§Ù„Ø« 3", "Ø§Ù„Ø«Ø§Ù„Ø« 4", "Ø§Ù„Ø«Ø§Ù„Ø« 5"],
    "Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹": ["Ø§Ù„Ø±Ø§Ø¨Ø¹ 1", "Ø§Ù„Ø±Ø§Ø¨Ø¹ 2", "Ø§Ù„Ø±Ø§Ø¨Ø¹ 3", "Ø§Ù„Ø±Ø§Ø¨Ø¹ 4", "Ø§Ù„Ø±Ø§Ø¨Ø¹ 5"],
    "Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³": ["Ø§Ù„Ø®Ø§Ù…Ø³ 1", "Ø§Ù„Ø®Ø§Ù…Ø³ 2", "Ø§Ù„Ø®Ø§Ù…Ø³ 3", "Ø§Ù„Ø®Ø§Ù…Ø³ 4"],
    "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³": ["Ø§Ù„Ø³Ø§Ø¯Ø³ 1", "Ø§Ù„Ø³Ø§Ø¯Ø³ 2", "Ø§Ù„Ø³Ø§Ø¯Ø³ 3", "Ø§Ù„Ø³Ø§Ø¯Ø³ 4"]
  };

  const allClasses = Object.values(gradeGroups).flat();

  let currentData = {};           // { "Ø§Ù„Ø±Ø§Ø¨Ø¹ 1": [ {name, average, photo}, ... ] }
  let currentClass = allClasses[0];

  // GitHub settings
  let githubSettings = {
    token: "",
    repo: "",
    branch: "main",
    filePath: "students-data.json"
  };

  // cropper globals
  let cropClassName = null;
  let cropIndex = null;
  let imageScale = 1;
  let imagePos = { x: 0, y: 0 };
  let dragStart = { x: 0, y: 0 };
  let isDragging = false;

  /* ===================== UI helpers ====================== */

  function showMessage(text, type = "info") {
    const box = document.getElementById('messageBox');
    box.textContent = text;
    box.className = "message show " + type;
  }

  function updateGitHubStatus() {
    const st = document.getElementById('githubStatus');
    const loadBtn = document.getElementById('btnLoad');
    const saveBtn = document.getElementById('btnSave');

    if (githubSettings.token && githubSettings.repo) {
      st.className = "github-status on";
      st.textContent = "ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ù€ GitHub: " + githubSettings.repo;
      loadBtn.disabled = false;
      saveBtn.disabled = false;
    } else {
      st.className = "github-status off";
      st.textContent = "ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù€ GitHub";
      loadBtn.disabled = true;
      saveBtn.disabled = true;
    }
  }

  /* ===================== Settings ====================== */

  function openSettings() {
    const token = prompt("GitHub Token:", githubSettings.token || "");
    if (token === null) return;

    const repo = prompt('Repository (Ù…Ø«Ø§Ù„: username/repo):', githubSettings.repo || "");
    if (repo === null) return;

    const filePath = prompt('Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (students-data.json):', githubSettings.filePath || "students-data.json");
    if (filePath === null) return;

    githubSettings.token = token.trim();
    githubSettings.repo = repo.trim();
    githubSettings.filePath = filePath.trim() || "students-data.json";

    localStorage.setItem('githubSettingsStudents', JSON.stringify(githubSettings));
    updateGitHubStatus();
    showMessage("ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub Ù…Ø­Ù„ÙŠØ§Ù‹.", "success");
  }

  function loadSettingsFromLocal() {
    const saved = localStorage.getItem('githubSettingsStudents');
    if (saved) {
      try {
        githubSettings = JSON.parse(saved);
      } catch (e) {}
    }
    updateGitHubStatus();
  }

  /* ===================== GitHub load/save ====================== */

  async function loadFromGitHub() {
    try {
      showMessage("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† GitHub...", "info");

      const url = `https://api.github.com/repos/${githubSettings.repo}/contents/${githubSettings.filePath}?ref=${githubSettings.branch}`;
      const res = await fetch(url, {
        headers: {
          "Authorization": "token " + githubSettings.token,
          "Accept": "application/vnd.github.v3+json"
        }
      });

      if (!res.ok) {
        if (res.status === 404) {
          showMessage("Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ GitHubØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø«Ù… Ø§Ù„Ø­ÙØ¸.", "info");
          currentData = {};
          renderClassSelect();
          renderStudentsForClass(currentClass);
          return;
        }
        throw new Error("ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† GitHub (status " + res.status + ")");
      }

      const json = await res.json();
      const content = atob(json.content);
      const data = JSON.parse(content);

      // Ù†Ø·Ø¨Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ currentData Ù…Ø¹ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ÙØ±Ø¯Ø© Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
      currentData = {};
      allClasses.forEach(cls => {
        if (data[cls]) {
          if (Array.isArray(data[cls])) {
            currentData[cls] = data[cls];
          } else {
            currentData[cls] = [data[cls]];
          }
        }
      });

      showMessage("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† GitHub Ø¨Ù†Ø¬Ø§Ø­.", "success");
      renderClassSelect();
      renderStudentsForClass(currentClass);

    } catch (e) {
      console.error(e);
      showMessage("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† GitHub.", "error");
    }
  }

  async function saveToGitHub() {
    try {
      showMessage("Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ GitHub...", "info");

      // Ù†Ù‚Ø±Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ currentData
      const dataToSave = { ...currentData };

      // Ù†ÙØ¹Ø¯Ù‘ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
      const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(dataToSave, null, 2))));

      // Ù†ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ SHA
      const getUrl = `https://api.github.com/repos/${githubSettings.repo}/contents/${githubSettings.filePath}?ref=${githubSettings.branch}`;
      let sha = null;
      try {
        const getRes = await fetch(getUrl, {
          headers: {
            "Authorization": "token " + githubSettings.token,
            "Accept": "application/vnd.github.v3+json"
          }
        });
        if (getRes.ok) {
          const existing = await getRes.json();
          sha = existing.sha;
        }
      } catch (e) {
        // Ù„Ø§ Ø¨Ø£Ø³ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯
      }

      const putUrl = `https://api.github.com/repos/${githubSettings.repo}/contents/${githubSettings.filePath}`;
      const body = {
        message: "Update students data - " + new Date().toLocaleString('ar-EG'),
        content: encoded,
        branch: githubSettings.branch
      };
      if (sha) body.sha = sha;

      const putRes = await fetch(putUrl, {
        method: "PUT",
        headers: {
          "Authorization": "token " + githubSettings.token,
          "Accept": "application/vnd.github.v3+json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      if (!putRes.ok) {
        throw new Error("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ (status " + putRes.status + ")");
      }

      showMessage("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ GitHub Ø¨Ù†Ø¬Ø§Ø­ âœ”ï¸", "success");

    } catch (e) {
      console.error(e);
      showMessage("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ GitHub.", "error");
    }
  }

  /* ===================== Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ====================== */

  function renderClassSelect() {
    const sel = document.getElementById('classSelect');
    sel.innerHTML = "";

    allClasses.forEach(cls => {
      const opt = document.createElement('option');
      opt.value = cls;
      opt.textContent = cls;
      sel.appendChild(opt);
    });

    if (!currentClass || !allClasses.includes(currentClass)) {
      currentClass = allClasses[0];
    }
    sel.value = currentClass;

    sel.onchange = function() {
      currentClass = this.value;
      renderStudentsForClass(currentClass);
    };

    document.getElementById('currentClassTitle').textContent = "Ø§Ù„ØµÙ: " + currentClass;
  }

  function renderStudentsForClass(className) {
    const container = document.getElementById('studentsContainer');
    const noMsg = document.getElementById('noStudentsMsg');

    document.getElementById('currentClassTitle').textContent = "Ø§Ù„ØµÙ: " + className;

    const students = currentData[className] || [];
    container.innerHTML = "";

    if (students.length === 0) {
      noMsg.style.display = 'block';
      return;
    } else {
      noMsg.style.display = 'none';
    }

    students.forEach((st, index) => {
      const card = document.createElement('div');
      card.className = "student-card";

      const photoHtml = st.photo
        ? `<img src="${st.photo}" alt="${st.name || ''}">`
        : `<span>ğŸ‘¤</span>`;

      card.innerHTML = `
        <div class="student-card-header">
          <div class="photo-frame">
            ${photoHtml}
          </div>
          <div class="student-basic-info">
            <div class="field-row">
              <div class="small-label">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</div>
              <input type="text" value="${st.name || ''}" 
                     oninput="updateStudentField('${className}', ${index}, 'name', this.value)">
            </div>
            <div class="field-row">
              <div class="small-label">Ø§Ù„Ù…Ø¹Ø¯Ù„ (%)</div>
              <input type="number" min="0" max="100" value="${st.average || ''}" 
                     oninput="updateStudentField('${className}', ${index}, 'average', this.value)">
            </div>
          </div>
        </div>
        <div class="student-card-footer">
          <button class="btn-small btn-photo" onclick="changePhoto('${className}', ${index})">ğŸ“· Ø§Ø®ØªÙŠØ§Ø± / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</button>
          <button class="btn-small btn-delete" onclick="deleteStudent('${className}', ${index})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
      `;

      container.appendChild(card);
    });
  }

  function addStudentToCurrentClass() {
    if (!currentData[currentClass]) {
      currentData[currentClass] = [];
    }

    currentData[currentClass].push({
      name: "",
      average: "",
      photo: ""
    });

    renderStudentsForClass(currentClass);
  }

  function deleteStudent(className, index) {
    if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")) return;
    if (!currentData[className]) return;
    currentData[className].splice(index, 1);
    renderStudentsForClass(className);
  }

  function updateStudentField(className, index, field, value) {
    if (!currentData[className]) currentData[className] = [];
    if (!currentData[className][index]) currentData[className][index] = { name: "", average: "", photo: "" };
    currentData[className][index][field] = value;
  }

  /* ===================== Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù‚Øµ ====================== */

  function changePhoto(className, index) {
    cropClassName = className;
    cropIndex = index;

    const input = document.createElement('input');
    input.type = "file";
    input.accept = "image/*";

    input.onchange = function() {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.getElementById('cropImage');
        img.src = e.target.result;
        imageScale = 1;
        imagePos = { x: 0, y: 0 };
        document.getElementById('zoomSlider').value = 100;
        setupCropEvents();
        document.getElementById('cropperModal').classList.add('show');
      };
      reader.readAsDataURL(file);
    };

    input.click();
  }

  function setupCropEvents() {
    const img = document.getElementById('cropImage');
    const slider = document.getElementById('zoomSlider');

    function updateTransform() {
      img.style.transform = `translate(calc(-50% + ${imagePos.x}px), calc(-50% + ${imagePos.y}px)) scale(${imageScale})`;
    }

    img.onmousedown = function(e) {
      isDragging = true;
      dragStart = {
        x: e.clientX - imagePos.x,
        y: e.clientY - imagePos.y
      };
      e.preventDefault();
    };

    document.onmousemove = function(e) {
      if (!isDragging) return;
      imagePos.x = e.clientX - dragStart.x;
      imagePos.y = e.clientY - dragStart.y;
      updateTransform();
    };

    document.onmouseup = function() {
      isDragging = false;
    };

    img.ontouchstart = function(e) {
      isDragging = true;
      const t = e.touches[0];
      dragStart = {
        x: t.clientX - imagePos.x,
        y: t.clientY - imagePos.y
      };
      e.preventDefault();
    };

    document.ontouchmove = function(e) {
      if (!isDragging) return;
      const t = e.touches[0];
      imagePos.x = t.clientX - dragStart.x;
      imagePos.y = t.clientY - dragStart.y;
      updateTransform();
    };

    document.ontouchend = function() {
      isDragging = false;
    };

    slider.oninput = function() {
      imageScale = this.value / 100;
      updateTransform();
    };

    // Ø£ÙˆÙ„ ØªØ­Ø¯ÙŠØ«
    updateTransform();
  }

  function closeCropper() {
    document.getElementById('cropperModal').classList.remove('show');
  }

  function applyCrop() {
    const img = document.getElementById('cropImage');
    const canvas = document.createElement('canvas');
    const size = 280;
    canvas.width = size;
    canvas.height = size;
    const ctx = canvas.getContext('2d');

    ctx.beginPath();
    ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
    ctx.closePath();
    ctx.clip();

    // Ù†Ø­Ø³Ø¨ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø¨Ø­Ø³Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const rect = img.getBoundingClientRect(); // Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… scale/translate Ø¨ØµØ±ÙŠÙ‹Ø§ Ø£ØµØ¹Ø¨
    // Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø·Ø±ÙŠÙ‚Ø© Ø£Ø¨Ø³Ø·: Ù†Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ù…ÙƒØ¨Ù‘Ø±Ø© ÙÙŠ ÙˆØ³Ø· Ø§Ù„ÙƒØ§Ù†ÙØ³ Ù…Ø¨Ø§Ø´Ø±Ø©
    // (Ø¯Ù‚Ù‘Ø© Ø¹Ø§Ù„ÙŠØ© Ù„ÙŠØ³Øª Ø­Ø±Ø¬Ø© Ù‡Ù†Ø§ØŒ Ø§Ù„Ù…Ù‡Ù… Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¹Ø§Ù…)
    ctx.drawImage(img, 0, 0, size, size);

    const dataUrl = canvas.toDataURL('image/png');

    if (!currentData[cropClassName]) currentData[cropClassName] = [];
    if (!currentData[cropClassName][cropIndex]) {
      currentData[cropClassName][cropIndex] = { name: "", average: "", photo: "" };
    }
    currentData[cropClassName][cropIndex].photo = dataUrl;

    closeCropper();
    renderStudentsForClass(cropClassName);
  }

  /* ===================== init ====================== */

  window.onload = function() {
    loadSettingsFromLocal();
    renderClassSelect();
    renderStudentsForClass(currentClass);
    showMessage("ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø«Ù… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø§Ø¨.", "info");
  };

</script>

</body>
</html>
